
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer</title>
    <style>
        * {
            margin: 0; padding: 0; box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff; min-height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; padding: 20px; overflow-x: hidden;
        }
        .container {
            width: 100%; max-width: 1200px;
            display: flex; flex-direction: column;
            align-items: center; gap: 20px;
        }
        header { text-align: center; padding: 20px; width: 100%; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { font-size: 1.2rem; opacity: 0.9; }
        
        .viewer-container {
            width: 100%; display: flex; flex-wrap: wrap;
            gap: 20px; justify-content: center;
        }
        #canvas-container {
            flex: 1; min-width: 300px; height: 500px;
            border-radius: 10px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            position: relative; background: #1a1a1a;
        }
        #canvas { width: 100%; height: 100%; display: block; }
        
        #controls {
            background: rgba(30, 30, 40, 0.8); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 10px; width: 300px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-height: 500px; overflow-y: auto;
        }
        .control-group { margin-bottom: 20px; }
        .control-group h3 {
            margin-bottom: 10px; color: #ff9d00;
            border-bottom: 1px solid #444; padding-bottom: 5px;
        }
        
        button {
            background: #4361ee; color: white; border: none;
            padding: 10px 15px; margin: 5px; border-radius: 5px;
            cursor: pointer; transition: all 0.3s;
            width: calc(100% - 10px); font-weight: 500;
        }
        button:hover { background: #3a56d4; transform: translateY(-2px); }
        .material-btn { background: #f72585; }
        .material-btn:hover { background: #d9047c; }
        .screenshot-btn { background: #4cc9f0; color: #000; }
        .screenshot-btn:hover { background: #3aa8d0; }
        
        .status {
            background: rgba(0, 0, 0, 0.3); padding: 15px;
            border-radius: 8px; margin-top: 15px; text-align: center;
        }
        .loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8); padding: 20px 30px;
            border-radius: 10px; text-align: center; display: none;
        }
        
        .color-control { display: flex; align-items: center; margin: 10px 5px; gap: 10px; }
        .color-control label { flex: 1; }
        .color-control input { width: 60px; height: 40px; border-radius: 5px; cursor: pointer; }
        
        .material-control { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin: 10px 5px; }
        .material-control button { margin: 2px; padding: 8px 12px; font-size: 12px; }
        
        .material-props { margin: 10px 5px; display: none; }
        .material-prop { display: flex; align-items: center; margin: 8px 0; gap: 10px; }
        .material-prop label { flex: 1; font-size: 14px; }
        .material-prop input { flex: 2; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>3D Model Viewer</h1>
            <p class="subtitle">View and interact with 3D models</p>
        </header>

        <div class="viewer-container">
            <div id="canvas-container">
                <canvas id="canvas"></canvas>
                <div class="loading" id="loading">
                    <h3>Loading Your Model...</h3>
                    <div id="progress">0%</div>
                </div>
            </div>

            <div id="controls">
                <div class="control-group">
                    <h3>Material Type</h3>
                    <div class="material-control">
                        <button class="material-btn" data-material="basic">Basic</button>
                        <button class="material-btn" data-material="standard">Standard</button>
                        <button class="material-btn" data-material="phong">Phong</button>
                        <button class="material-btn" data-material="lambert">Lambert</button>
                        <button class="material-btn" data-material="toon">Toon</button>
                        <button class="material-btn" data-material="normal">Normal</button>
                    </div>
                    <div class="material-props" id="material-props">
                        <div class="material-prop">
                            <label for="metalness">Metalness:</label>
                            <input type="range" id="metalness" min="0" max="1" step="0.1" value="0">
                        </div>
                        <div class="material-prop">
                            <label for="roughness">Roughness:</label>
                            <input type="range" id="roughness" min="0" max="1" step="0.1" value="0.5">
                        </div>
                        <div class="material-prop">
                            <label for="shininess">Shininess:</label>
                            <input type="range" id="shininess" min="0" max="100" step="1" value="30">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Model Controls</h3>
                    <div class="color-control">
                        <label for="model-color">Model Color:</label>
                        <input type="color" id="model-color" value="#ff6b6b">
                    </div>
                    <button id="toggle-wireframe">Wireframe: Off</button>
                    <div class="rotation-control">
                        <label for="rotation-speed">Auto Rotation:</label>
                        <input type="range" id="rotation-speed" min="0" max="2" step="0.1" value="0.5">
                    </div>
                    <button id="toggle-rotation">Auto Rotation: Off</button>
                </div>

                <div class="control-group">
                    <h3>View Controls</h3>
                    <button id="reset-view">Reset View</button>
                    <button id="toggle-grid">Grid: On</button>
                    <button id="toggle-axes">Axes: On</button>
                </div>

                <div class="control-group">
                    <h3>Environment</h3>
                    <button id="bg-dark">Dark BG</button>
                    <button id="bg-light">Light BG</button>
                    <button id="bg-gradient">Gradient BG</button>
                </div>

                <div class="control-group">
                    <h3>Screenshot</h3>
                    <button id="take-screenshot" class="screenshot-btn">Take Screenshot</button>
                </div>

                <div class="status" id="status">Loading your model...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/OBJLoader.js"></script>

    <script>
        // Get model data from URL parameters
        function getModelDataFromParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const modelParam = urlParams.get('model');
            if (modelParam) {
                try {
                    return JSON.parse(decodeURIComponent(modelParam));
                } catch (e) {
                    console.error("Error parsing model data:", e);
                }
            }
            return null;
        }

        let currentModel = null;
        let currentMaterials = [];
        let currentMaterialType = 'phong';
        
        // Initialize Three.js
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x2c3e50);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 5, 10);
        
        const renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('canvas'), 
            antialias: true,
            preserveDrawingBuffer: true
        });
        
        const container = document.getElementById('canvas-container');
        renderer.setSize(container.offsetWidth, container.offsetHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
        directionalLight.position.set(10, 10, 10);
        scene.add(directionalLight);
        
        // Helpers
        const gridHelper = new THREE.GridHelper(20, 20, 0x888888, 0x444444);
        scene.add(gridHelper);
        
        const axesHelper = new THREE.AxesHelper(10);
        scene.add(axesHelper);
        
        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function createMaterial(type, color) {
            const colorValue = color || document.getElementById('model-color').value;
            
            switch(type) {
                case 'basic': return new THREE.MeshBasicMaterial({ color: colorValue });
                case 'standard': 
                    return new THREE.MeshStandardMaterial({ 
                        color: colorValue,
                        metalness: parseFloat(document.getElementById('metalness').value),
                        roughness: parseFloat(document.getElementById('roughness').value)
                    });
                case 'phong':
                    return new THREE.MeshPhongMaterial({ 
                        color: colorValue,
                        specular: 0x111111,
                        shininess: parseFloat(document.getElementById('shininess').value)
                    });
                case 'lambert': return new THREE.MeshLambertMaterial({ color: colorValue });
                case 'toon': return new THREE.MeshToonMaterial({ color: colorValue });
                case 'normal': return new THREE.MeshNormalMaterial();
                default: return new THREE.MeshPhongMaterial({ color: colorValue });
            }
        }
        
        function setupModel(model) {
            if (currentModel) scene.remove(currentModel);
            
            model.traverse((child) => {
                if (child.isMesh) {
                    child.material = createMaterial(currentMaterialType);
                }
            });
            
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            model.position.x = -center.x;
            model.position.y = -center.y;
            model.position.z = -center.z;
            
            currentModel = model;
            scene.add(currentModel);
            
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / (2 * Math.tan(fov / 2)));
            
            camera.position.set(0, 0, cameraZ * 1.5);
            controls.target.set(0, 0, 0);
            controls.update();
            
            showLoading(false);
            updateStatus("✓ Model loaded successfully!");
        }
        
        // Load model from data
        async function loadModel(modelData) {
            showLoading(true);
            updateStatus("Loading model...");
            
            try {
                if (modelData.type === 'url') {
                    const loader = new THREE.GLTFLoader();
                    loader.load(
                        modelData.url,
                        (gltf) => setupModel(gltf.scene),
                        (xhr) => {
                            const percent = Math.round((xhr.loaded / xhr.total) * 100);
                            document.getElementById('progress').textContent = percent + '%';
                        },
                        (error) => {
                            throw new Error("Failed to load model from URL");
                        }
                    );
                } else if (modelData.type === 'file') {
                    if (modelData.format === 'stl') {
                        const loader = new THREE.STLLoader();
                        const geometry = loader.parse(modelData.data);
                        const material = createMaterial(currentMaterialType);
                        const mesh = new THREE.Mesh(geometry, material);
                        setupModel(mesh);
                    } else {
                        // Handle other formats
                        updateStatus("File format not supported in viewer", true);
                    }
                }
            } catch (error) {
                showLoading(false);
                updateStatus("Error loading model: " + error.message, true);
            }
        }
        
        // Auto-load model on page load
        window.addEventListener('load', () => {
            const modelData = getModelDataFromParams();
            if (modelData) {
                setTimeout(() => loadModel(modelData), 1000);
            } else {
                updateStatus("No model data found", true);
            }
        });
        
        // Event listeners for controls
        document.querySelectorAll('.material-btn').forEach(button => {
            button.addEventListener('click', function() {
                currentMaterialType = this.dataset.material;
                if (currentModel) {
                    currentModel.traverse((child) => {
                        if (child.isMesh) {
                            child.material = createMaterial(currentMaterialType);
                        }
                    });
                }
                
                const materialProps = document.getElementById('material-props');
                materialProps.style.display = 
                    (currentMaterialType === 'standard' || currentMaterialType === 'phong') 
                    ? 'block' : 'none';
            });
        });
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>