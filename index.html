<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer PRO</title>
    <style>
        /* Все предыдущие стили остаются без изменений до .screenshot-preview */
        
        /* UPDATED: Better screenshot preview layout */
        .screenshot-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        
        .screenshot-preview-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: row;
            gap: 20px;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            height: calc(100vh - 40px);
            overflow: hidden;
        }
        
        .screenshot-preview h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .annotation-sidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .screenshot-image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            border-radius: 5px;
            background: #1a1a1a;
            padding: 10px;
            max-height: 100%;
        }
        
        .screenshot-image-container img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
            border: 2px solid #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .annotation-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(40, 40, 50, 0.8);
            padding: 15px;
            border-radius: 8px;
        }
        
        .annotation-control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .annotation-control-row label {
            min-width: 140px;
            font-size: 14px;
        }
        
        .annotation-control-row input {
            flex: 1;
        }
        
        .annotation-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .annotation-buttons button {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            min-width: 120px;
        }
        
        .annotation-canvas-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            max-height: 100%;
        }
        
        #annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        
        /* Selected annotation styling */
        .annotation-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            background: rgba(30, 30, 40, 0.7);
            border-radius: 5px;
            padding: 5px;
        }
        
        .annotation-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 3px 0;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .annotation-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .annotation-item.selected {
            background: rgba(76, 201, 240, 0.3);
            border: 1px solid #4cc9f0;
        }
        
        .annotation-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #f72585;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .annotation-size {
            margin-left: auto;
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Comment controls */
        .comment-controls {
            margin-top: 10px;
            padding: 10px;
            background: rgba(50, 50, 60, 0.7);
            border-radius: 5px;
            display: none;
        }
        
        .comment-control-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .comment-control-row label {
            font-size: 14px;
        }
        
        .comment-control-row select, 
        .comment-control-row input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background: rgba(30, 30, 40, 0.8);
            color: white;
        }
        
        .comment-control-row textarea {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background: rgba(30, 30, 40, 0.8);
            color: white;
            resize: vertical;
            min-height: 60px;
        }
        
        .comment-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4cc9f0;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        /* NEW: Close button at top right */
        .close-preview-top {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: all 0.3s;
        }
        
        .close-preview-top:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .screenshot-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .screenshot-buttons button {
            width: auto;
            padding: 10px 20px;
            min-width: 180px;
        }
        
        /* NEW: Zoom controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(30, 30, 40, 0.8);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }
        
        .zoom-controls button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        /* NEW: Instructions */
        .annotation-instructions {
            background: rgba(40, 40, 50, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.4;
        }
        
        @media (max-width: 1024px) {
            .screenshot-preview-content {
                flex-direction: column;
                height: auto;
                max-height: calc(100vh - 40px);
            }
            
            .annotation-sidebar {
                width: 100%;
                max-height: 40vh;
            }
            
            .screenshot-image-container {
                max-height: 50vh;
            }
        }
        
        @media (max-width: 768px) {
            .screenshot-preview {
                padding: 10px;
            }
            
            .screenshot-preview-content {
                padding: 15px;
            }
            
            .annotation-control-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .annotation-control-row label {
                min-width: auto;
            }
            
            .screenshot-buttons {
                flex-direction: column;
            }
            
            .screenshot-buttons button {
                width: 100%;
            }
            
            .annotation-sidebar {
                max-height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>3D Model Viewer PRO</h1>
            <p class="subtitle">Professional 3D model viewer with material controls and annotation tools</p>
        </header>

        <div class="viewer-container">
            <div id="canvas-container">
                <canvas id="canvas"></canvas>
                <div class="loading" id="loading">
                    <h3>Loading Model...</h3>
                    <div id="progress">0%</div>
                </div>
            </div>

            <div id="controls">
                <!-- Controls remain the same as before -->
                <div class="control-group">
                    <h3>File Upload</h3>
                    <div class="file-input-container">
                        <label for="file-input" class="file-input-label">
                            Choose 3D Model File
                        </label>
                        <input type="file" id="file-input" accept=".stl,.glb,.obj">
                        <p class="format-info">Supports: STL, GLB, OBJ formats (up to 100MB)</p>
                        <p class="file-size-warning" id="file-size-warning">
                            Large files may take longer to process
                        </p>
                        <div class="upload-progress" id="upload-progress">
                            <div class="upload-progress-bar" id="upload-progress-bar"></div>
                        </div>
                        <div class="upload-status" id="upload-status"></div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Share Model</h3>
                    <button id="generate-link" class="screenshot-btn">Generate Temporary Link</button>
                    <div class="share-controls" id="share-controls">
                        <div class="share-link-container">
                            <input type="text" id="share-link" readonly>
                            <button id="copy-link">Copy</button>
                        </div>
                        <p class="share-info">This link will be valid for 24 hours</p>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Material Type</h3>
                    <div class="material-control">
                        <button class="material-btn" data-material="basic">Basic</button>
                        <button class="material-btn" data-material="standard">Standard</button>
                        <button class="material-btn" data-material="phong">Phong</button>
                        <button class="material-btn" data-material="lambert">Lambert</button>
                        <button class="material-btn" data-material="toon">Toon</button>
                        <button class="material-btn" data-material="normal">Normal</button>
                    </div>
                    <div class="material-props" id="material-props">
                        <div class="material-prop">
                            <label for="metalness">Metalness:</label>
                            <input type="range" id="metalness" min="0" max="1" step="0.1" value="0">
                        </div>
                        <div class="material-prop">
                            <label for="roughness">Roughness:</label>
                            <input type="range" id="roughness" min="0" max="1" step="0.1" value="0.5">
                        </div>
                        <div class="material-prop">
                            <label for="shininess">Shininess:</label>
                            <input type="range" id="shininess" min="0" max="100" step="1" value="30">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Model Controls</h3>
                    <div class="color-control">
                        <label for="model-color">Model Color:</label>
                        <input type="color" id="model-color" value="#ff6b6b">
                    </div>
                    <button id="toggle-wireframe">Wireframe: Off</button>
                    <div class="rotation-control">
                        <label for="rotation-speed">Auto Rotation Speed:</label>
                        <input type="range" id="rotation-speed" min="0" max="2" step="0.1" value="0.5">
                    </div>
                    <button id="toggle-rotation">Auto Rotation: Off</button>
                    <div class="direction-control">
                        <button id="rotation-direction" class="direction-btn">Rotation: CW</button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>View Controls</h3>
                    <button id="reset-view">Reset View</button>
                    <button id="toggle-grid">Grid: On</button>
                    <button id="toggle-axes">Axes: On</button>
                </div>

                <div class="control-group">
                    <h3>Environment</h3>
                    <button id="bg-dark">Dark BG</button>
                    <button id="bg-light">Light BG</button>
                    <button id="bg-gradient">Gradient BG</button>
                </div>

                <div class="control-group">
                    <h3>Screenshot</h3>
                    <button id="take-screenshot" class="screenshot-btn">Take Screenshot</button>
                </div>

                <div class="status" id="status">Ready to load 3D model</div>
            </div>
        </div>

        <!-- UPDATED: Improved screenshot preview layout -->
        <div class="screenshot-preview" id="screenshot-preview">
            <button class="close-preview-top" id="close-preview-top">×</button>
            <div class="screenshot-preview-content">
                <div class="annotation-sidebar">
                    <h3>Screenshot Annotations</h3>
                    
                    <div class="annotation-instructions">
                        <p><strong>How to use:</strong></p>
                        <p>• Click on the image to add markers</p>
                        <p>• Drag markers to move them</p>
                        <p>• Click on a marker in the list to select it</p>
                        <p>• Use Ctrl+Click to select without dragging</p>
                    </div>
                    
                    <div class="annotation-controls">
                        <div class="annotation-control-row">
                            <label for="default-annotation-radius">Default Marker Radius:</label>
                            <input type="range" id="default-annotation-radius" min="10" max="50" value="20">
                            <span id="default-radius-value">20px</span>
                        </div>
                        
                        <div id="selected-annotation-controls" style="display: none;">
                            <div class="annotation-control-row">
                                <label for="selected-annotation-radius">Selected Marker Radius:</label>
                                <input type="range" id="selected-annotation-radius" min="10" max="50" value="20">
                                <span id="selected-radius-value">20px</span>
                            </div>
                            
                            <!-- Comment controls for selected annotation -->
                            <div class="comment-controls" id="comment-controls">
                                <div class="comment-control-row">
                                    <label for="comment-type">Comment Type:</label>
                                    <select id="comment-type">
                                        <option value="">No comment</option>
                                        <option value="make_more_convex">Сделать более выпуклым</option>
                                        <option value="make_more_concave">Сделать более вдавленным</option>
                                        <option value="make_narrower_width">Сделать уже по ширине</option>
                                        <option value="make_wider_width">Сделать шире по ширине</option>
                                        <option value="make_narrower_height">Сделать уже по высоте</option>
                                        <option value="make_wider_height">Сделать шире по высоте</option>
                                        <option value="custom">Свой вариант</option>
                                    </select>
                                </div>
                                
                                <div class="comment-control-row" id="custom-comment-container" style="display: none;">
                                    <label for="custom-comment">Custom Comment:</label>
                                    <textarea id="custom-comment" placeholder="Введите ваш комментарий..."></textarea>
                                </div>
                                
                                <div class="comment-control-row">
                                    <button id="save-comment" class="screenshot-btn">Save Comment</button>
                                </div>
                            </div>
                            
                            <div style="text-align: center; font-size: 12px; margin-top: 5px;">
                                Editing Marker <span id="selected-annotation-number">1</span>
                            </div>
                        </div>
                        
                        <div class="annotation-buttons">
                            <button id="clear-annotations" class="screenshot-btn">Clear All Markers</button>
                            <button id="delete-selected-annotation" class="screenshot-btn">Delete Selected</button>
                        </div>
                        
                        <div class="annotation-list" id="annotation-list">
                            <!-- Annotation items will be added here dynamically -->
                        </div>
                    </div>
                    
                    <div class="screenshot-buttons">
                        <button id="download-annotated-screenshot" class="screenshot-btn">Download with Markers & Comments</button>
                        <button id="close-preview">Close Preview</button>
                    </div>
                </div>
                
                <div class="screenshot-image-container">
                    <div class="annotation-canvas-container">
                        <img id="screenshot-image" src="" alt="Screenshot">
                        <canvas id="annotation-canvas"></canvas>
                    </div>
                    
                    <!-- NEW: Zoom controls -->
                    <div class="zoom-controls">
                        <button id="zoom-in">+</button>
                        <button id="zoom-out">-</button>
                        <button id="reset-zoom">⟳</button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>3D Model Viewer PRO | Professional material controls, rendering and annotation tools</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/OBJLoader.js"></script>

    <script>
        // Все предыдущие функции и переменные остаются без изменений
        
        // NEW: Zoom functionality for screenshot preview
        let zoomLevel = 1;
        let isDraggingImage = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let imageOffsetX = 0;
        let imageOffsetY = 0;
        
        function initAnnotationCanvas() {
            annotationCanvas = document.getElementById('annotation-canvas');
            annotationCtx = annotationCanvas.getContext('2d');
            
            // Set canvas size to match the image
            const img = document.getElementById('screenshot-image');
            annotationCanvas.width = img.clientWidth;
            annotationCanvas.height = img.clientHeight;
            
            // Reset zoom and position
            zoomLevel = 1;
            imageOffsetX = 0;
            imageOffsetY = 0;
            updateImageTransform();
            
            // Clear previous annotations
            annotations = [];
            annotationCounter = 1;
            selectedAnnotation = null;
            updateAnnotationList();
            redrawAnnotations();
        }
        
        function updateImageTransform() {
            const img = document.getElementById('screenshot-image');
            const container = document.querySelector('.annotation-canvas-container');
            
            img.style.transform = `translate(${imageOffsetX}px, ${imageOffsetY}px) scale(${zoomLevel})`;
            annotationCanvas.style.transform = `translate(${imageOffsetX}px, ${imageOffsetY}px) scale(${zoomLevel})`;
            
            // Update canvas size to match scaled image
            annotationCanvas.style.width = (img.naturalWidth * zoomLevel) + 'px';
            annotationCanvas.style.height = (img.naturalHeight * zoomLevel) + 'px';
            
            // Redraw annotations with correct scaling
            redrawAnnotations();
        }
        
        function zoomIn() {
            if (zoomLevel < 3) {
                zoomLevel += 0.1;
                updateImageTransform();
            }
        }
        
        function zoomOut() {
            if (zoomLevel > 0.5) {
                zoomLevel -= 0.1;
                updateImageTransform();
            }
        }
        
        function resetZoom() {
            zoomLevel = 1;
            imageOffsetX = 0;
            imageOffsetY = 0;
            updateImageTransform();
        }
        
        // Update annotation functions to work with zoom
        function getAnnotationAt(x, y) {
            // Adjust coordinates for zoom and pan
            const adjustedX = (x - imageOffsetX) / zoomLevel;
            const adjustedY = (y - imageOffsetY) / zoomLevel;
            
            for (let i = annotations.length - 1; i >= 0; i--) {
                const annotation = annotations[i];
                const distance = Math.sqrt(
                    Math.pow(adjustedX - annotation.x, 2) + 
                    Math.pow(adjustedY - annotation.y, 2)
                );
                
                if (distance <= annotation.radius / zoomLevel) {
                    return annotation;
                }
            }
            return null;
        }
        
        function addAnnotation(x, y) {
            // Adjust coordinates for zoom and pan
            const adjustedX = (x - imageOffsetX) / zoomLevel;
            const adjustedY = (y - imageOffsetY) / zoomLevel;
            
            const annotation = {
                id: annotationCounter++,
                x: adjustedX,
                y: adjustedY,
                radius: defaultAnnotationRadius,
                comment: null
            };
            
            annotations.push(annotation);
            updateAnnotationList();
            redrawAnnotations();
        }
        
        // Update event listeners for annotation canvas
        document.getElementById('annotation-canvas').addEventListener('mousedown', function(event) {
            const rect = annotationCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Check if we're starting to drag the image (middle click or space + click)
            if (event.button === 1 || event.altKey) {
                isDraggingImage = true;
                dragStartX = x - imageOffsetX;
                dragStartY = y - imageOffsetY;
                annotationCanvas.style.cursor = 'grabbing';
                return;
            }
            
            const annotation = getAnnotationAt(x, y);
            
            if (annotation) {
                // Start dragging existing annotation or select it
                if (event.ctrlKey || event.metaKey) {
                    // If Ctrl/Cmd is pressed, just select without dragging
                    selectAnnotation(annotation);
                } else {
                    // Start dragging
                    isDraggingAnnotation = true;
                    draggedAnnotation = annotation;
                    selectAnnotation(annotation);
                }
            } else {
                // Add new annotation
                addAnnotation(x, y);
                // Select the new annotation
                selectAnnotation(annotations[annotations.length - 1]);
            }
        });
        
        document.getElementById('annotation-canvas').addEventListener('mousemove', function(event) {
            const rect = annotationCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            if (isDraggingImage) {
                imageOffsetX = x - dragStartX;
                imageOffsetY = y - dragStartY;
                updateImageTransform();
            } else if (isDraggingAnnotation && draggedAnnotation) {
                // Adjust coordinates for zoom and pan
                const adjustedX = (x - imageOffsetX) / zoomLevel;
                const adjustedY = (y - imageOffsetY) / zoomLevel;
                
                draggedAnnotation.x = adjustedX;
                draggedAnnotation.y = adjustedY;
                redrawAnnotations();
            }
        });
        
        document.getElementById('annotation-canvas').addEventListener('mouseup', function() {
            isDraggingAnnotation = false;
            isDraggingImage = false;
            draggedAnnotation = null;
            annotationCanvas.style.cursor = 'crosshair';
        });
        
        document.getElementById('annotation-canvas').addEventListener('mouseleave', function() {
            isDraggingAnnotation = false;
            isDraggingImage = false;
            draggedAnnotation = null;
            annotationCanvas.style.cursor = 'crosshair';
        });
        
        // Add zoom controls event listeners
        document.getElementById('zoom-in').addEventListener('click', zoomIn);
        document.getElementById('zoom-out').addEventListener('click', zoomOut);
        document.getElementById('reset-zoom').addEventListener('click', resetZoom);
        
        // Add keyboard shortcuts for zoom
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('screenshot-preview').style.display === 'flex') {
                if (event.ctrlKey || event.metaKey) {
                    if (event.key === '=') {
                        event.preventDefault();
                        zoomIn();
                    } else if (event.key === '-') {
                        event.preventDefault();
                        zoomOut();
                    } else if (event.key === '0') {
                        event.preventDefault();
                        resetZoom();
                    }
                }
            }
        });
        
        // Update redrawAnnotations to work with zoom
        function redrawAnnotations() {
            // Clear canvas
            annotationCtx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
            
            // Scale the context to match the current zoom level
            annotationCtx.save();
            annotationCtx.scale(zoomLevel, zoomLevel);
            
            // Draw all annotations
            annotations.forEach(annotation => {
                // Draw circle
                annotationCtx.beginPath();
                annotationCtx.arc(annotation.x, annotation.y, annotation.radius, 0, 2 * Math.PI);
                
                // Use different color for selected annotation
                if (annotation === selectedAnnotation) {
                    annotationCtx.strokeStyle = '#4cc9f0';
                    annotationCtx.lineWidth = 4 / zoomLevel;
                } else {
                    annotationCtx.strokeStyle = '#ff0000';
                    annotationCtx.lineWidth = 3 / zoomLevel;
                }
                
                annotationCtx.stroke();
                
                // Draw number
                annotationCtx.fillStyle = annotation === selectedAnnotation ? '#4cc9f0' : '#ff0000';
                annotationCtx.font = 'bold ' + (annotation.radius * 0.8) + 'px Arial';
                annotationCtx.textAlign = 'center';
                annotationCtx.textBaseline = 'middle';
                annotationCtx.fillText(annotation.id.toString(), annotation.x, annotation.y);
                
                // Draw comment if exists
                if (annotation.comment) {
                    const commentText = annotation.comment.type === 'custom' 
                        ? annotation.comment.text 
                        : commentOptions[annotation.comment.type];
                    
                    if (commentText) {
                        // Draw comment text below the marker
                        annotationCtx.fillStyle = '#4cc9f0';
                        annotationCtx.font = (12 / zoomLevel) + 'px Arial';
                        annotationCtx.textAlign = 'center';
                        annotationCtx.textBaseline = 'top';
                        
                        // Draw background for better readability
                        const textMetrics = annotationCtx.measureText(commentText);
                        const textWidth = textMetrics.width;
                        const textHeight = 16 / zoomLevel;
                        const padding = 4 / zoomLevel;
                        
                        annotationCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                        annotationCtx.fillRect(
                            annotation.x - textWidth/2 - padding,
                            annotation.y + annotation.radius + 5,
                            textWidth + padding*2,
                            textHeight + padding
                        );
                        
                        // Draw text
                        annotationCtx.fillStyle = '#ffffff';
                        annotationCtx.fillText(
                            commentText,
                            annotation.x,
                            annotation.y + annotation.radius + 5 + padding/2
                        );
                    }
                }
            });
            
            annotationCtx.restore();
        }
        
        // Остальной код остается без изменений...
        
        // Take screenshot function
        function takeScreenshot() {
            if (!currentModel) {
                updateStatus("No model loaded to take screenshot", true);
                return;
            }
            
            // Render the scene to ensure we have the latest frame
            renderer.render(scene, camera);
            
            // Get the canvas data URL
            const dataURL = renderer.domElement.toDataURL('image/png');
            currentScreenshotUrl = dataURL;
            
            // Show preview
            const preview = document.getElementById('screenshot-preview');
            const screenshotImage = document.getElementById('screenshot-image');
            screenshotImage.src = dataURL;
            preview.style.display = 'flex';
            
            // Initialize annotation canvas after image loads
            screenshotImage.onload = function() {
                initAnnotationCanvas();
            };
            
            updateStatus("Screenshot captured - preview shown", false);
        }
        
        // ... остальной код без изменений
    </script>
</body>
</html>